<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24/7oncall å®¢æˆ¶ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="quickOrderView" class="hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
        <h1 id="prodName" class="text-xl font-bold text-gray-800 mb-2 text-center">è¼‰å…¥ä¸­...</h1>
        <p id="prodPrice" class="text-red-500 font-bold text-3xl mb-8 text-center">--</p>

        <div class="space-y-6">
            <div>
                <label class="block text-gray-500 text-sm mb-2">é¡è‰²</label>
                <div id="colorContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <label class="block text-gray-500 text-sm mb-2">å°ºå¯¸</label>
                <div id="sizeContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex items-center justify-between border-t pt-6">
                <span class="text-gray-700 font-medium">ä¸‹å–®æ•¸é‡</span>
                <div class="flex items-center border-2 border-gray-100 rounded-xl overflow-hidden">
                    <button onclick="updateQty(-1)" class="px-4 py-2 bg-gray-50 hover:bg-gray-100">-</button>
                    <span id="qtyText" class="px-6 py-2 font-bold text-lg min-w-[3.5rem] text-center">1</span>
                    <button onclick="updateQty(1)" class="px-4 py-2 bg-gray-50 hover:bg-gray-100">+</button>
                </div>
            </div>
        </div>
        <button onclick="submitOrder()" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
            ç¢ºèªå–Šå–®
        </button>
    </div>

    <div id="historyView" class="hidden w-full max-w-md space-y-4">
        <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg mb-6">
            <p class="text-sm opacity-80 text-center">ç›®å‰å¾…ä»˜æ¬¾ç¸½é¡</p>
            <h2 id="unpaidTotal" class="text-3xl font-bold font-mono text-center">$ --</h2>
        </div>
        <div id="orderList" class="space-y-3">
            </div>
    </div>

    <div id="deliveryView" class="hidden w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">é…é€é€²åº¦</h2>
            <div id="deliveryList" class="space-y-4 text-gray-500 text-center py-10">
                åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…...
            </div>
        </div>
    </div>

    <!-- Currency Update View -->
    <div id="currencyView" class="hidden w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 id="currencyTitle" class="text-xl font-bold mb-1 text-center text-gray-800">åŒ¯ç‡è¨­å®š</h2>
            <p id="currencySub" class="text-center text-gray-400 text-sm mb-6"></p>

            <div class="space-y-6">
                <div>
                   <label class="block text-gray-500 text-sm mb-2 font-bold" for="rateInput">è¼¸å…¥æ–°åŒ¯ç‡</label>
                   <div class="relative">
                        <input type="number" id="rateInput" inputmode="decimal" step="0.01" 
                               class="w-full px-4 py-4 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-blue-500 focus:bg-white focus:outline-none text-3xl font-bold text-center text-gray-800 transition-all placeholder-gray-300"
                               placeholder="0.00">
                   </div>
                   <p class="text-xs text-gray-400 mt-2 text-center">è«‹è¼¸å…¥å®Œæ•´æ•¸å­—ï¼Œä¾‹å¦‚: 32.5</p>
                </div>

                <button onclick="submitRate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    ç¢ºèªæ›´æ–°
                </button>
            </div>
        </div>
    </div>
    
    <!-- Redirect Transition Modal -->
    <div id="redirectModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-extrabold text-gray-900 mb-3">å‰å¾€å®˜æ–¹å¸³è™Ÿ</h3>
                <p id="redirectText" class="text-gray-500 text-sm mb-8 leading-relaxed">
                    å³å°‡é–‹å•Ÿå®˜æ–¹å¸³è™ŸèŠå¤©å®¤ï¼Œè«‹åœ¨é€²å…¥å¾Œé»æ“Šã€ç™¼é€ã€å³å¯å®Œæˆä¸‹å–®ã€‚
                </p>
                
                <button id="redirectGoBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-200 transition-all active:scale-[0.98]">
                    ç«‹å³å‰å¾€èŠå¤©å®¤
                </button>
            </div>
        </div>
    </div>

    <!-- Copy Dialog Modal -->
    <div id="copyModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-gray-100 text-gray-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">è«‹æ‰‹å‹•ç™¼é€æŒ‡ä»¤</h3>
                <p class="text-gray-500 text-sm mb-6 leading-relaxed">
                    ç”±æ–¼ LINE éš±ç§è¨­å®šé™åˆ¶ï¼Œè«‹è¤‡è£½ä¸‹æ–¹æŒ‡ä»¤ï¼Œä¸¦åœ¨å®˜æ–¹å¸³è™ŸèŠå¤©å®¤ä¸­è²¼ä¸Šä»¥å®Œæˆè¨‚è³¼ã€‚
                </p>
                
                <div class="bg-gray-100 border border-gray-200 rounded-xl p-4 mb-6 select-all font-mono text-sm text-gray-700 break-all text-left">
                    <p id="msgToCopy"></p>
                    <p id="copyToast" class="hidden text-green-600 text-[10px] font-bold mt-1">âœ“ å·²è¤‡è£½æŒ‡ä»¤ï¼</p>
                </div>

                <div class="space-y-3">
                    <button id="copyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                        <span>è¤‡è£½ä¸¦å‰å¾€ä¸‹å–®</span>
                    </button>
                    <button onclick="liff.closeWindow()" class="w-full text-gray-400 font-medium text-xs py-2 hover:text-gray-600">
                        é—œé–‰è¦–çª—
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Debugger -->
    <div id="debugLog" class="fixed bottom-0 left-0 w-full bg-black bg-opacity-75 text-white text-[10px] p-2 max-h-32 overflow-y-auto z-50 pointer-events-none"></div>

    <script>
        // Debug Logger
        function log(msg) {
            const el = document.getElementById('debugLog');
            if(el) {
                el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerText;
            }
            console.log(msg);
        }

        let state = { uid: '', name: '', price: '', color: '', size: '', qty: 1 };
        // è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨éƒ¨ç½²åœ¨ Heroku çš„ API ç¶²å€
        const API_BASE_URL = "https://tracking-line-prod-48e7277f81cf.herokuapp.com";

        function getParam(name) {
            const urlObj = new URL(window.location.href);
            let val = urlObj.searchParams.get(name);
            if (!val && urlObj.searchParams.has('liff.state')) {
                const stateStr = decodeURIComponent(urlObj.searchParams.get('liff.state'));
                const stateParams = new URLSearchParams(stateStr.substring(stateStr.indexOf('?')));
                val = stateParams.get(name);
            }
            if (val) {
                try {
                    let decoded = decodeURIComponent(val);
                    if (decoded.includes('%')) decoded = decodeURIComponent(decoded);
                    return decoded;
                } catch (e) { return val; }
            }
            return null;
        }

        async function handleShare() {
            const uid = getParam('uid');
            const name = getParam('name') || 'å•†å“';
            const price = getParam('price') || '0';
            const image = getParam('image');
            const colors = getParam('colors') || 'None';
            const sizes = getParam('sizes') || 'None';

            const LIFF_ID = "2009061767-yr41hYAj";
            
            // âœ… æ§‹å»º LIFF URLï¼Œè®“ Client B é»æ“Šå¾Œé€²å…¥é¸æ“‡é é¢
            // ä½¿ç”¨ liff.line.me æ ¼å¼ç¢ºä¿åœ¨ LINE å…§éƒ¨é–‹å•Ÿ
            const liffParams = new URLSearchParams();
            liffParams.set('uid', uid);
            liffParams.set('name', name);
            liffParams.set('price', price);
            if (colors && colors !== 'None') liffParams.set('colors', colors);
            if (sizes && sizes !== 'None') liffParams.set('sizes', sizes);
            if (image) liffParams.set('image', image);
            
            const buyUrl = `https://liff.line.me/${LIFF_ID}?${liffParams.toString()}`;
            const addFriendUrl = "https://line.me/R/ti/p/@694nscli";

            const bubble = {
                "type": "bubble",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        { "type": "text", "text": name, "weight": "bold", "size": "xl", "wrap": true },
                        { "type": "text", "text": `åƒ¹æ ¼: ${price}`, "size": "md", "margin": "md", "color": "#d93025" }
                    ]
                },
                "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "button",
                            "style": "primary",
                            "color": "#00C300",
                            "action": { "type": "uri", "label": "ç«‹å³è³¼è²·", "uri": buyUrl }
                        },
                        {
                            "type": "button",
                            "style": "primary",
                            "height": "sm",
                            "action": {
                                "type": "uri",
                                "label": "åŠ å…¥å®˜æ–¹å¸³è™Ÿ",
                                "uri": addFriendUrl
                            },
                            "margin": "sm"
                        }
                    ]
                }
            };
            
            if (image) {
                bubble.hero = {
                    "type": "image",
                    "url": image,
                    "size": "full",
                    "aspectRatio": "20:13",
                    "aspectMode": "cover",
                    "action": { "type": "uri", "uri": buyUrl }
                };
            }

            const flexMsg = {
                "type": "flex",
                "altText": `æ¨è–¦å•†å“ï¼š${name}`,
                "contents": bubble
            };

            try {
                document.getElementById('quickOrderView').classList.remove('hidden');
                document.getElementById('prodName').innerText = "æº–å‚™åˆ†äº«ä¸­...";
                document.getElementById('prodPrice').innerText = "";

                const res = await liff.shareTargetPicker([flexMsg]);
                if (res) {
                    liff.closeWindow();
                } else {
                    renderQuickOrder();
                }
            } catch (err) {
                log('Share failed: ' + err);
                alert('åˆ†äº«å¤±æ•—ï¼š' + err.message);
                renderQuickOrder();
            }
        }

        async function runRender() {
            // Determine page
            const page = getParam('page');
            const action = getParam('action');

            if (action === 'share') {
                await handleShare();
                return;
            }

            // --- å¼·åˆ¶æª¢æŸ¥å€ (ä¸»è¦é‡å°å–Šå–®ã€æ­·å²ã€é…é€é é¢) ---
            if (!page || ['quickorder', 'history', 'delivery'].includes(page)) {
                // 1. å¦‚æœåœ¨ LINE å¤–éƒ¨é–‹å•Ÿï¼Œå¼·åˆ¶é‡å°å‘è‡³ LIFF URL (ç¢ºä¿èƒ½å¤ æ­£ç¢ºç²å– userId èˆ‡ç’°å¢ƒ)
                if (!liff.isInClient()) {
                    log('External URL detected. Redirecting to LIFF Link...');
                    const LIFF_URL = "https://liff.line.me/2009061767-yr41hYAj";
                    const dest = new URL(LIFF_URL);
                    new URLSearchParams(window.location.search).forEach((v, k) => dest.searchParams.set(k, v));
                    window.location.href = dest.toString();
                    return;
                }

                // 2. åœ¨ LINE å…§éƒ¨ç’°å¢ƒä¸‹ï¼Œæª¢æŸ¥å¥½å‹ç‹€æ…‹
                try {
                    const friendship = await liff.getFriendship();
                    log('Friendship check: ' + friendship.friendFlag);
                    if (!friendship.friendFlag) {
                        log('Not a friend. Redirecting to follow page...');
                        window.location.href = "https://line.me/R/ti/p/@694nscli";
                        return;
                    }
                } catch (err) {
                    log('Friendship API Error: ' + err);
                    // é‡å°ã€Œæœªé€£çµ Botã€éŒ¯èª¤æä¾›æ›´æ¸…æ¥šçš„æŒ‡ç¤º
                    if (err.message && err.message.includes('login bot')) {
                        alert('ç³»çµ±è¨­å®šæé†’ï¼š\nè«‹è‡³ LINE Developers Console çš„ LIFF åˆ†é ï¼Œå°‡ "Linked Bot" è¨­å®šç‚ºæ‚¨çš„å®˜æ–¹å¸³è™Ÿï¼Œå¦å‰‡ç„¡æ³•ä¸»å‹•æª¢æŸ¥å¥½å‹ç‹€æ…‹ã€‚');
                    }
                }
            }

            let userId = null;
            try {
                if (liff.isLoggedIn()) {
                    userId = liff.getContext().userId;
                }
            } catch (e) { console.warn('LIFF context not available', e); }

            if (page === 'history') {
                document.getElementById('historyView').classList.remove('hidden');
                if (userId) {
                    loadOrderHistory(userId);
                } else {
                    document.getElementById('orderList').innerHTML = '<p class="text-center text-red-400 py-10">ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š (è«‹åœ¨ LINE ä¸­é–‹å•Ÿ)</p>';
                }
            } else if (page === 'delivery') {
                document.getElementById('deliveryView').classList.remove('hidden');
            } else if (page === 'currency') {
                document.getElementById('currencyView').classList.remove('hidden');
                renderCurrencyEdit();
            } else {
                document.getElementById('quickOrderView').classList.remove('hidden');
                renderQuickOrder();
            }
        }

        async function renderCurrencyEdit() {
            // Get currency code and current rate from URL
            const code = getParam('code') || 'USD';
            const rate = getParam('rate') || '';
            
            document.getElementById('currencyTitle').innerText = `${code} åŒ¯ç‡è¨­å®š`;
            document.getElementById('currencySub').innerText = `ç›®å‰è¨­å®šï¼š${rate}`;
            document.getElementById('rateInput').value = rate;
            
            // Store code in state for submission
            state.currencyCode = code;
        }

        async function submitRate() {
            const newRate = document.getElementById('rateInput').value;
            if (!newRate || isNaN(newRate)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—åŒ¯ç‡');
                return;
            }
            
            const msg = `åŒ¯ç‡ update ${state.currencyCode} ${newRate}`;
            
            try {
                if (!liff.isInClient()) {
                    alert('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æŒ‡ä»¤è‡³èŠå¤©å®¤ï¼š\n' + msg);
                    return;
                }
                await liff.sendMessages([{ type: 'text', text: msg }]);
                liff.closeWindow();
            } catch (err) {
                console.error(err);
                alert('ç™¼é€å¤±æ•—ï¼š' + (err.message || err));
            }
        }

        async function init() {
            try {
                log('Starting LIFF init...');
                await liff.init({ liffId: "2009061767-yr41hYAj" });
                
                if (!liff.isLoggedIn()) {
                    log('Not logged in, calling login...');
                    liff.login({ 
                        redirectUri: window.location.href,
                        botPrompt: 'normal'
                    });
                    return;
                }
                
                log('Init success. Logged In.');
                await runRender();
            } catch (err) { 
                log('LIFF init failed: ' + err);
                // Fallback render
                await runRender();
            }
        }

        // --- æ­·å²è¨‚å–®é‚è¼¯ ---
        async function loadOrderHistory(userId) {
            const listContainer = document.getElementById('orderList');
            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${userId}`);
                const data = await response.json();

                // è™•ç†å¾…ä»˜æ¬¾ç¸½é¡ (å–çµ•å°å€¼ä¸¦åŠ ä¸Šåƒåˆ†ä½)
                const total = Math.abs(data.unpaid_total || 0);
                document.getElementById('unpaidTotal').innerText = `$${total.toLocaleString()}`;

                if (!data.orders || data.orders.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400 py-10">å°šç„¡ç´€éŒ„</p>';
                    return;
                }

                listContainer.innerHTML = data.orders.map(order => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-400 font-mono">${order.order_no}</span>
                            <span class="px-2 py-0.5 rounded text-[10px] ${order.status === 'unpaid' ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}">
                                ${order.status === 'unpaid' ? 'å¾…ä»˜æ¬¾' : 'å·²çµæ¸…'}
                            </span>
                        </div>
                        <div class="space-y-1 mb-2">
                            ${order.items.map(item => `
                                <div class="flex justify-between items-center text-sm italic py-1">
                                    <div class="flex items-center gap-2">
                                        ${item.image ? `<img src="${item.image}" class="w-10 h-10 object-cover rounded border border-gray-100" loading="lazy">` : ''}
                                        <div class="flex flex-col">
                                            <span class="text-gray-600">${item.name}</span>
                                            <span class="text-xs text-gray-400">x${item.qty}</span>
                                        </div>
                                    </div>
                                    <span class="text-gray-900">$${item.price}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-50 text-[10px]">
                            <span class="text-gray-400">${order.date}</span>
                            <span class="text-gray-900 font-bold text-sm">$${Math.abs(order.total).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                listContainer.innerHTML = '<p class="text-center text-red-400">é€£ç·š API å¤±æ•—</p>';
            }
        }

        // --- åŸæœ‰çš„å–Šå–®æ¸²æŸ“é‚è¼¯ ---
        function renderQuickOrder() {
            state.uid = getParam('uid') || 'Unknown';
            state.name = getParam('name') || 'å•†å“';
            state.price = getParam('price') || '0';
            
            document.getElementById('prodName').innerText = state.name;
            document.getElementById('prodPrice').innerText = `$${state.price}`;
            renderButtons('colorContainer', getParam('colors'), 'color');
            renderButtons('sizeContainer', getParam('sizes'), 'size');
        }

        function renderButtons(containerId, dataStr, type) {
            const container = document.getElementById(containerId);
            if (!dataStr || dataStr.toLowerCase() === 'none') {
                container.innerHTML = `<span class="text-gray-400 text-sm">ç„¡</span>`;
                state[type] = 'None';
                return;
            }
            const items = dataStr.split(',');
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.innerText = item;
                btn.className = "px-4 py-2 border-2 border-gray-100 rounded-lg text-sm transition-all";
                btn.onclick = () => {
                    state[type] = item;
                    Array.from(container.children).forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                };
                container.appendChild(btn);
            });
            if (items.length === 1) container.firstChild.click();
        }

        function updateQty(n) {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qtyText').innerText = state.qty;
        }

        /**
         * æ ¸å¿ƒä¸‹å–®é‚è¼¯ï¼šAPI ä»£ç™¼ -> å®šå‘ OA è·³è½‰ -> æ‰‹å‹•è¤‡è£½å‚™æ´
         */
        async function submitOrder() {
            // æª¢æŸ¥å¿…é¸æ¬„ä½
            if (!state.color || !state.size) {
                alert('è«‹å®Œæ•´é¸æ“‡é¡è‰²èˆ‡å°ºå¯¸');
                return; 
            }

            const orderMessage = `${state.uid} ${state.color} ${state.size} +${state.qty}`;
            const encodedMsg = encodeURIComponent(orderMessage);
            const OA_LINK = `https://line.me/R/oaMessage/@694nscli/?${encodedMsg}`;
            
            log('é–‹å§‹è™•ç†è¨‚å–®: ' + orderMessage);

            // --- ç¬¬ä¸€å±¤ï¼šå¤–éƒ¨ç€è¦½å™¨ç›´æ¥è·³è½‰ ---
            if (!liff.isInClient()) {
                log('å¤–éƒ¨ç€è¦½å™¨ç’°å¢ƒï¼Œç›´æ¥å°å‘ OA');
                window.location.href = OA_LINK;
                return;
            }

            // --- ç¬¬äºŒå±¤ï¼šLINE å…§éƒ¨ LIFF å˜—è©¦ API ç™¼é€ ---
            try {
                log('å˜—è©¦ä½¿ç”¨ liff.sendMessages API');
                await liff.sendMessages([{ type: 'text', text: orderMessage }]);
                log('è¨Šæ¯ç™¼é€æˆåŠŸ');
                liff.closeWindow();
            } catch (err) {
                log('API ç™¼é€å¤±æ•—: ' + err.message);
                
                // --- ç¬¬ä¸‰å±¤ï¼šé¡¯ç¤ºå¼•å° Modal è®“ä½¿ç”¨è€…æ‰‹å‹•é»æ“Šè·³è½‰ ---
                const redirectModal = document.getElementById('redirectModal');
                const goBtn = document.getElementById('redirectGoBtn');
                
                if (redirectModal && goBtn) {
                    redirectModal.classList.remove('hidden');
                    
                    // ğŸ”¥ é—œéµï¼šå¿…é ˆåœ¨ onclick å…§åŒæ­¥åŸ·è¡Œ window.location.href
                    goBtn.onclick = () => {
                        log('ä½¿ç”¨è€…é»æ“Šå°å‘æŒ‰éˆ•');
                        window.location.href = OA_LINK;
                    };
                } else {
                    // ç·Šæ€¥å‚™æ´
                    showManualCopyModal(orderMessage);
                }
            }
        }

        /**
         * è¼”åŠ©åŠŸèƒ½ï¼šé¡¯ç¤ºæ‰‹å‹•è¤‡è£½ Modal (ç”¨æ–¼ API èˆ‡è·³è½‰çš†å¤±æ•ˆçš„æœ€æ¥µç«¯æƒ…æ³)
         */
        function showManualCopyModal(orderMessage) {
            const modal = document.getElementById('copyModal');
            const msgEl = document.getElementById('msgToCopy');
            const toast = document.getElementById('copyToast');
            
            if (modal && msgEl) {
                msgEl.innerText = orderMessage;
                modal.classList.remove('hidden');
                
                const copyBtn = document.getElementById('copyBtn');
                copyBtn.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(orderMessage);
                        if (toast) toast.classList.remove('hidden');
                        log('æŒ‡ä»¤å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                        
                        // è¤‡è£½å¾Œå¼•å°ç”¨æˆ¶é»æ“Šé–‹å•Ÿ LINE æˆ–æ‰‹å‹•é—œé–‰
                        setTimeout(() => {
                            if (liff.isInClient()) liff.closeWindow();
                        }, 1500);
                    } catch (copyErr) {
                        prompt('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æŒ‡ä»¤ï¼š', orderMessage);
                    }
                };
            }
        }

        init();
    </script>
</body>
</html>