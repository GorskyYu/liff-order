<script>
    let state = { uid: '', name: '', price: '', color: '', size: '', qty: 1 };
    const API_BASE_URL = "https://tracking-line-prod-48e7277f81cf.herokuapp.com";

    function getParam(name) {
        const urlObj = new URL(window.location.href);
        let val = urlObj.searchParams.get(name);
        if (!val && urlObj.searchParams.has('liff.state')) {
            const stateStr = decodeURIComponent(urlObj.searchParams.get('liff.state'));
            const stateParams = new URLSearchParams(stateStr.substring(stateStr.indexOf('?')));
            val = stateParams.get(name);
        }
        if (val) {
            try {
                let decoded = decodeURIComponent(val);
                if (decoded.includes('%')) decoded = decodeURIComponent(decoded);
                return decoded;
            } catch (e) { return val; }
        }
        return null;
    }

    async function init() {
        console.log("LIFF Starting...");
        try {
            await liff.init({ liffId: "2009025778-m8CGWmqW" });
            
            if (!liff.isLoggedIn()) {
                console.log("User not logged in, redirecting to login...");
                liff.login();
                return;
            }

            // --- 關鍵修改：動態取得 UID ---
            const profile = await liff.getProfile();
            const currentUserId = profile.userId; 
            console.log("Current User ID Detected:", currentUserId);

            const page = getParam('page');
            console.log("Current Page Type:", page);

            if (page === 'history') {
                document.getElementById('historyView').classList.remove('hidden');
                // 確保傳入的是當前 profile 的 userId
                loadOrderHistory(currentUserId); 
            } else if (page === 'delivery') {
                document.getElementById('deliveryView').classList.remove('hidden');
            } else {
                document.getElementById('quickOrderView').classList.remove('hidden');
                renderQuickOrder();
            }
        } catch (err) { 
            console.error('LIFF Init Error:', err);
            document.body.innerHTML = `
                <div class="p-8 text-center bg-white rounded-xl shadow-xl">
                    <p class="text-red-500 font-bold text-xl mb-4">無法驗證身分</p>
                    <p class="text-gray-600 mb-4">${err.message}</p>
                    <button onclick="window.location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">重試</button>
                </div>`;
        }
    }

    async function loadOrderHistory(targetUserId) {
        const listContainer = document.getElementById('orderList');
        console.log("Fetching orders for:", targetUserId);
        
        try {
            // 使用傳入的動態 UID 構建 API URL
            const fetchUrl = `${API_BASE_URL}/api/orders/${targetUserId}`;
            console.log("API Request URL:", fetchUrl);

            const response = await fetch(fetchUrl);
            const data = await response.json();
            console.log("API Response Data:", data);

            const total = Math.abs(data.unpaid_total || 0);
            document.getElementById('unpaidTotal').innerText = `$${total.toLocaleString()}`;

            if (!data.orders || data.orders.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 py-10">尚無紀錄</p>';
                return;
            }

            listContainer.innerHTML = data.orders.map(order => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] text-gray-400 font-mono">${order.order_no}</span>
                        <span class="px-2 py-0.5 rounded text-[10px] ${order.status === 'unpaid' ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}">
                            ${order.status === 'unpaid' ? '待付款' : '已結清'}
                        </span>
                    </div>
                    <div class="space-y-1 mb-2">
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm italic">
                                <span class="text-gray-600">${item.name} x${item.qty}</span>
                                <span class="text-gray-900">$${item.price}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-50 text-[10px]">
                        <span class="text-gray-400">${order.date}</span>
                        <span class="text-gray-900 font-bold text-sm">$${Math.abs(order.total).toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error("Fetch API Error:", e);
            listContainer.innerHTML = '<p class="text-center text-red-400">連線 API 失敗</p>';
        }
    }

    // ... (保留其餘 renderQuickOrder, renderButtons, updateQty, submitOrder) ...
    function renderQuickOrder() {
        state.uid = getParam('uid') || 'Unknown';
        state.name = getParam('name') || '商品';
        state.price = getParam('price') || '0';
        
        document.getElementById('prodName').innerText = state.name;
        document.getElementById('prodPrice').innerText = `$${state.price}`;
        renderButtons('colorContainer', getParam('colors'), 'color');
        renderButtons('sizeContainer', getParam('sizes'), 'size');
    }

    function renderButtons(containerId, dataStr, type) {
        const container = document.getElementById(containerId);
        if (!dataStr || dataStr.toLowerCase() === 'none') {
            container.innerHTML = `<span class="text-gray-400 text-sm">無</span>`;
            state[type] = 'None';
            return;
        }
        const items = dataStr.split(',');
        items.forEach(item => {
            const btn = document.createElement('button');
            btn.innerText = item;
            btn.className = "px-4 py-2 border-2 border-gray-100 rounded-lg text-sm transition-all";
            btn.onclick = () => {
                state[type] = item;
                Array.from(container.children).forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                btn.classList.add('border-blue-500', 'bg-blue-50');
            };
            container.appendChild(btn);
        });
        if (items.length === 1) container.firstChild.click();
    }

    function updateQty(n) {
        state.qty = Math.max(1, state.qty + n);
        document.getElementById('qtyText').innerText = state.qty;
    }

    async function submitOrder() {
        if (!state.color || !state.size) return alert('請完整選擇');
        const msg = `${state.uid} ${state.color} ${state.size} +${state.qty}`;
        await liff.sendMessages([{ type: 'text', text: msg }]);
        liff.closeWindow();
    }

    init();
</script>