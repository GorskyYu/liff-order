<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24/7oncall å®¢æˆ¶ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="quickOrderView" class="hidden bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
        <h1 id="prodName" class="text-xl font-bold text-gray-800 mb-2 text-center">è¼‰å…¥ä¸­...</h1>
        <p id="prodPrice" class="text-red-500 font-bold text-3xl mb-8 text-center">--</p>

        <div class="space-y-6">
            <div>
                <label class="block text-gray-500 text-sm mb-2">é¡è‰²</label>
                <div id="colorContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <label class="block text-gray-500 text-sm mb-2">å°ºå¯¸</label>
                <div id="sizeContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex items-center justify-between border-t pt-6">
                <span class="text-gray-700 font-medium">ä¸‹å–®æ•¸é‡</span>
                <div class="flex items-center border-2 border-gray-100 rounded-xl overflow-hidden">
                    <button onclick="updateQty(-1)" class="px-4 py-2 bg-gray-50 hover:bg-gray-100">-</button>
                    <span id="qtyText" class="px-6 py-2 font-bold text-lg min-w-[3.5rem] text-center">1</span>
                    <button onclick="updateQty(1)" class="px-4 py-2 bg-gray-50 hover:bg-gray-100">+</button>
                </div>
            </div>
        </div>
        <button id="addToCartBtn" onclick="addToCart()" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <span>åŠ å…¥è³¼ç‰©è»Š</span>
        </button>
    </div>

    <div id="historyView" class="hidden w-full max-w-md space-y-4">
        <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg mb-6">
            <p class="text-sm opacity-80 text-center">ç›®å‰å¾…ä»˜æ¬¾ç¸½é¡</p>
            <h2 id="unpaidTotal" class="text-3xl font-bold font-mono text-center">$ --</h2>
        </div>
        <div id="orderList" class="space-y-3">
            </div>
    </div>

    <div id="deliveryView" class="hidden w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold mb-4">é…é€é€²åº¦</h2>
            <div id="deliveryList" class="space-y-4 text-gray-500 text-center py-10">
                åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…...
            </div>
        </div>
    </div>

    <!-- Currency Update View -->
    <div id="currencyView" class="hidden w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 id="currencyTitle" class="text-xl font-bold mb-1 text-center text-gray-800">åŒ¯ç‡è¨­å®š</h2>
            <p id="currencySub" class="text-center text-gray-400 text-sm mb-6"></p>

            <div class="space-y-6">
                <div>
                   <label class="block text-gray-500 text-sm mb-2 font-bold" for="rateInput">è¼¸å…¥æ–°åŒ¯ç‡</label>
                   <div class="relative">
                        <input type="number" id="rateInput" inputmode="decimal" step="0.01" 
                               class="w-full px-4 py-4 rounded-xl bg-gray-50 border-2 border-gray-100 focus:border-blue-500 focus:bg-white focus:outline-none text-3xl font-bold text-center text-gray-800 transition-all placeholder-gray-300"
                               placeholder="0.00">
                   </div>
                   <p class="text-xs text-gray-400 mt-2 text-center">è«‹è¼¸å…¥å®Œæ•´æ•¸å­—ï¼Œä¾‹å¦‚: 32.5</p>
                </div>

                <button onclick="submitRate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    ç¢ºèªæ›´æ–°
                </button>
            </div>
        </div>
    </div>

    <!-- Added to Cart Modal -->
    <div id="addedModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <!-- Success Icon -->
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-900 mb-2">å·²åŠ å…¥è³¼ç‰©è»Šï¼</h3>
                <p class="text-gray-500 mb-8">
                    è³¼ç‰©è»Šå…± <span id="modalCartCount" class="font-bold text-blue-600">0</span> ä»¶å•†å“
                </p>
                
                <div class="space-y-3">
                    <button onclick="goToCart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all">
                        ğŸ›’ æŸ¥çœ‹è³¼ç‰©è»Š
                    </button>
                    <button onclick="continueShopping()" class="w-full border-2 border-gray-200 hover:border-gray-300 text-gray-600 font-bold py-4 rounded-xl transition-all">
                        ç¹¼çºŒè³¼ç‰©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart View -->
    <div id="cartView" class="hidden w-full max-w-md">
        <!-- Header -->
        <div class="bg-white rounded-t-2xl shadow-sm">
            <h1 class="text-xl font-bold text-center py-4 border-b">ğŸ›’ æˆ‘çš„è³¼ç‰©è»Š</h1>
        </div>
        
        <!-- Loading State -->
        <div id="cartLoading" class="bg-white p-10 text-center">
            <div class="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
            <p class="text-gray-400 mt-4">è¼‰å…¥ä¸­...</p>
        </div>
        
        <!-- Cart Items Container -->
        <div id="cartItems" class="hidden bg-white divide-y divide-gray-100 max-h-[55vh] overflow-y-auto">
            <!-- Items rendered dynamically -->
        </div>
        
        <!-- Empty Cart State -->
        <div id="emptyCart" class="hidden bg-white p-10 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-10 h-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
            </div>
            <p class="text-gray-500 mb-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>
            <button onclick="liff.closeWindow()" class="text-blue-600 font-medium">å»é€›é€› â†’</button>
        </div>
        
        <!-- Footer (Total + Buttons) -->
        <div id="cartFooter" class="hidden bg-white rounded-b-2xl shadow-lg border-t">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600">å…± <span id="cartItemCount">0</span> ä»¶å•†å“</span>
                    <div class="text-right">
                        <span class="text-gray-400 text-sm">ç¸½è¨ˆ</span>
                        <span id="cartTotal" class="text-2xl font-bold text-red-500 ml-2">$0</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="liff.closeWindow()" class="py-4 border-2 border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-gray-50 transition-all">
                        ç¹¼çºŒè³¼ç‰©
                    </button>
                    <button onclick="checkout()" class="py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                        <span>å‰å¾€çµå¸³</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Redirect Transition Modal -->
    <div id="redirectModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[110] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <h3 class="text-2xl font-extrabold text-gray-900 mb-3">å‰å¾€å®˜æ–¹å¸³è™Ÿ</h3>
                <p id="redirectText" class="text-gray-500 text-sm mb-8 leading-relaxed">
                    å³å°‡é–‹å•Ÿå®˜æ–¹å¸³è™ŸèŠå¤©å®¤ï¼Œè«‹åœ¨é€²å…¥å¾Œé»æ“Šã€ç™¼é€ã€å³å¯å®Œæˆä¸‹å–®ã€‚
                </p>
                
                <button id="redirectGoBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-200 transition-all active:scale-[0.98]">
                    ç«‹å³å‰å¾€èŠå¤©å®¤
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Result Modal -->
    <div id="paymentResultModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[120] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <!-- Success Icon (shown when payment=success) -->
                <div id="paymentSuccessIcon" class="hidden w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <!-- Error Icon (shown when payment=error) -->
                <div id="paymentErrorIcon" class="hidden w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <!-- Cancelled Icon -->
                <div id="paymentCancelledIcon" class="hidden w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                
                <h3 id="paymentResultTitle" class="text-2xl font-bold text-gray-900 mb-2"></h3>
                <p id="paymentResultMessage" class="text-gray-500 mb-8"></p>
                
                <button onclick="closePaymentResult()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition-all">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <!-- LINE Pay Loading Modal -->
    <div id="linePayLoadingModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
            <div class="p-8 text-center">
                <div class="animate-spin w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">æ­£åœ¨é€£æ¥ LINE Pay...</h3>
                <p class="text-gray-500 text-sm">è«‹ç¨å€™ï¼Œå³å°‡è·³è½‰è‡³ä»˜æ¬¾é é¢</p>
            </div>
        </div>
    </div>
    
    <!-- Mobile Debugger -->
    <div id="debugLog" class="hidden fixed bottom-0 left-0 w-full bg-black bg-opacity-75 text-white text-[10px] p-2 max-h-32 overflow-y-auto z-50 pointer-events-none"></div>

    <script>
        // Debug Logger
        function log(msg) {
            const el = document.getElementById('debugLog');
            if(el) {
                el.innerText = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.innerText;
            }
            console.log(msg);
        }

        // Event Tracker - sends events to backend for debugging
        // Uses multiple methods (fetch + image beacon) for reliability
        async function trackEvent(action, data = {}) {
            try {
                let userId = null;
                try {
                    if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
                        const ctx = liff.getContext();
                        userId = ctx?.userId;
                    }
                } catch (e) { /* ignore */ }
                
                const payload = {
                    action,
                    data,
                    userId,
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                
                // Method 1: fetch (may be blocked by CORS in some WebViews)
                fetch(`${API_BASE_URL}/api/liff-log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).catch(() => {}); // Silently ignore errors
                
                // Method 2: Image beacon (works even when fetch fails)
                const beacon = new Image();
                const params = new URLSearchParams({
                    a: action,
                    u: userId || '',
                    d: JSON.stringify(data).substring(0, 500)
                });
                beacon.src = `${API_BASE_URL}/api/liff-ping?${params.toString()}`;
                
                log(`[TRACK] ${action}: ${JSON.stringify(data)}`);
            } catch (e) {
                console.warn('trackEvent error:', e);
            }
        }

        let state = { uid: '', name: '', price: '', color: '', size: '', qty: 1 };
        // è«‹å°‡æ­¤è™•æ”¹ç‚ºæ‚¨éƒ¨ç½²åœ¨ Heroku çš„ API ç¶²å€
        const API_BASE_URL = "https://tracking-line-prod-48e7277f81cf.herokuapp.com";

        function getParam(name) {
            const urlObj = new URL(window.location.href);
            let val = urlObj.searchParams.get(name);
            if (!val && urlObj.searchParams.has('liff.state')) {
                const stateStr = decodeURIComponent(urlObj.searchParams.get('liff.state'));
                const stateParams = new URLSearchParams(stateStr.substring(stateStr.indexOf('?')));
                val = stateParams.get(name);
            }
            if (val) {
                try {
                    let decoded = decodeURIComponent(val);
                    if (decoded.includes('%')) decoded = decodeURIComponent(decoded);
                    return decoded;
                } catch (e) { return val; }
            }
            return null;
        }

        async function handleShare() {
            const uid = getParam('uid');
            const name = getParam('name') || 'å•†å“';
            const price = getParam('price') || '0';
            const image = getParam('image');
            const colors = getParam('colors') || 'None';
            const sizes = getParam('sizes') || 'None';

            trackEvent('share_start', { uid, name, price });

            const LIFF_ID = "2009061767-yr41hYAj";
            
            // âœ… æ§‹å»º LIFF URLï¼Œè®“ Client B é»æ“Šå¾Œé€²å…¥é¸æ“‡é é¢
            // ä½¿ç”¨ liff.line.me æ ¼å¼ç¢ºä¿åœ¨ LINE å…§éƒ¨é–‹å•Ÿ
            const liffParams = new URLSearchParams();
            liffParams.set('uid', uid);
            liffParams.set('name', name);
            liffParams.set('price', price);
            if (colors && colors !== 'None') liffParams.set('colors', colors);
            if (sizes && sizes !== 'None') liffParams.set('sizes', sizes);
            if (image) liffParams.set('image', image);
            
            const buyUrl = `https://liff.line.me/${LIFF_ID}?${liffParams.toString()}`;
            const addFriendUrl = "https://line.me/R/ti/p/@694nscli";

            const bubble = {
                "type": "bubble",
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        { "type": "text", "text": name, "weight": "bold", "size": "xl", "wrap": true },
                        { "type": "text", "text": `åƒ¹æ ¼: ${price}`, "size": "md", "margin": "md", "color": "#d93025" }
                    ]
                },
                "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "button",
                            "style": "primary",
                            "color": "#00C300",
                            "action": { "type": "uri", "label": "ç«‹å³è³¼è²·", "uri": buyUrl }
                        },
                        {
                            "type": "button",
                            "style": "primary",
                            "height": "sm",
                            "action": {
                                "type": "uri",
                                "label": "åŠ å…¥å®˜æ–¹å¸³è™Ÿ",
                                "uri": addFriendUrl
                            },
                            "margin": "sm"
                        }
                    ]
                }
            };
            
            if (image) {
                bubble.hero = {
                    "type": "image",
                    "url": image,
                    "size": "full",
                    "aspectRatio": "20:13",
                    "aspectMode": "cover",
                    "action": { "type": "uri", "uri": buyUrl }
                };
            }

            const flexMsg = {
                "type": "flex",
                "altText": `æ¨è–¦å•†å“ï¼š${name}`,
                "contents": bubble
            };

            try {
                document.getElementById('quickOrderView').classList.remove('hidden');
                document.getElementById('prodName').innerText = "æº–å‚™åˆ†äº«ä¸­...";
                document.getElementById('prodPrice').innerText = "";

                const res = await liff.shareTargetPicker([flexMsg]);
                if (res) {
                    trackEvent('share_complete', { uid, name });
                    liff.closeWindow();
                } else {
                    trackEvent('share_cancelled', { uid, name });
                    renderQuickOrder();
                }
            } catch (err) {
                log('Share failed: ' + err);
                trackEvent('share_error', { uid, name, error: err.message || String(err) });
                alert('åˆ†äº«å¤±æ•—ï¼š' + err.message);
                renderQuickOrder();
            }
        }

        async function runRender() {
            // Determine page
            const page = getParam('page');
            const action = getParam('action');
            
            trackEvent('page_view', { page: page || 'quickorder', action, uid: getParam('uid') });

            if (action === 'share') {
                await handleShare();
                return;
            }

            // --- å¼·åˆ¶æª¢æŸ¥å€ (ä¸»è¦é‡å°å–Šå–®ã€æ­·å²ã€é…é€é é¢) ---
            if (!page || ['quickorder', 'history', 'delivery'].includes(page)) {
                // 1. å¦‚æœåœ¨ LINE å¤–éƒ¨é–‹å•Ÿï¼Œå¼·åˆ¶é‡å°å‘è‡³ LIFF URL (ç¢ºä¿èƒ½å¤ æ­£ç¢ºç²å– userId èˆ‡ç’°å¢ƒ)
                if (!liff.isInClient()) {
                    log('External URL detected. Redirecting to LIFF Link...');
                    const LIFF_URL = "https://liff.line.me/2009061767-yr41hYAj";
                    const dest = new URL(LIFF_URL);
                    new URLSearchParams(window.location.search).forEach((v, k) => dest.searchParams.set(k, v));
                    window.location.href = dest.toString();
                    return;
                }

                // 2. åœ¨ LINE å…§éƒ¨ç’°å¢ƒä¸‹ï¼Œæª¢æŸ¥å¥½å‹ç‹€æ…‹
                try {
                    const friendship = await liff.getFriendship();
                    log('Friendship check: ' + friendship.friendFlag);
                    if (!friendship.friendFlag) {
                        log('Not a friend. Redirecting to follow page...');
                        window.location.href = "https://line.me/R/ti/p/@694nscli";
                        return;
                    }
                } catch (err) {
                    log('Friendship API Error: ' + err);
                    // é‡å°ã€Œæœªé€£çµ Botã€éŒ¯èª¤æä¾›æ›´æ¸…æ¥šçš„æŒ‡ç¤º
                    if (err.message && err.message.includes('login bot')) {
                        alert('ç³»çµ±è¨­å®šæé†’ï¼š\nè«‹è‡³ LINE Developers Console çš„ LIFF åˆ†é ï¼Œå°‡ "Linked Bot" è¨­å®šç‚ºæ‚¨çš„å®˜æ–¹å¸³è™Ÿï¼Œå¦å‰‡ç„¡æ³•ä¸»å‹•æª¢æŸ¥å¥½å‹ç‹€æ…‹ã€‚');
                    }
                }
            }

            let userId = null;
            try {
                if (liff.isLoggedIn()) {
                    userId = liff.getContext().userId;
                }
            } catch (e) { console.warn('LIFF context not available', e); }

            if (page === 'history') {
                document.getElementById('historyView').classList.remove('hidden');
                if (userId) {
                    loadOrderHistory(userId);
                } else {
                    document.getElementById('orderList').innerHTML = '<p class="text-center text-red-400 py-10">ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š (è«‹åœ¨ LINE ä¸­é–‹å•Ÿ)</p>';
                }
            } else if (page === 'cart') {
                document.getElementById('cartView').classList.remove('hidden');
                
                // Check for payment result params
                const paymentResult = getParam('payment');
                if (paymentResult) {
                    handlePaymentResult(paymentResult, getParam('orderId'), getParam('msg'));
                }
                
                if (userId) {
                    loadCart(userId);
                } else {
                    document.getElementById('cartItems').innerHTML = '<p class="text-center text-red-400 py-10">ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š</p>';
                }
            } else if (page === 'delivery') {
                document.getElementById('deliveryView').classList.remove('hidden');
            } else if (page === 'currency') {
                document.getElementById('currencyView').classList.remove('hidden');
                renderCurrencyEdit();
            } else {
                document.getElementById('quickOrderView').classList.remove('hidden');
                renderQuickOrder();
            }
        }

        async function renderCurrencyEdit() {
            // Get currency code and current rate from URL
            const code = getParam('code') || 'USD';
            const rate = getParam('rate') || '';
            
            document.getElementById('currencyTitle').innerText = `${code} åŒ¯ç‡è¨­å®š`;
            document.getElementById('currencySub').innerText = `ç›®å‰è¨­å®šï¼š${rate}`;
            document.getElementById('rateInput').value = rate;
            
            // Store code in state for submission
            state.currencyCode = code;
        }

        async function submitRate() {
            const newRate = document.getElementById('rateInput').value;
            if (!newRate || isNaN(newRate)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—åŒ¯ç‡');
                return;
            }
            
            const msg = `åŒ¯ç‡ update ${state.currencyCode} ${newRate}`;
            
            try {
                if (!liff.isInClient()) {
                    alert('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹æŒ‡ä»¤è‡³èŠå¤©å®¤ï¼š\n' + msg);
                    return;
                }
                await liff.sendMessages([{ type: 'text', text: msg }]);
                liff.closeWindow();
            } catch (err) {
                console.error(err);
                alert('ç™¼é€å¤±æ•—ï¼š' + (err.message || err));
            }
        }

        async function init() {
            try {
                log('Starting LIFF init...');
                trackEvent('liff_init_start');
                await liff.init({ liffId: "2009061767-yr41hYAj" });
                
                if (!liff.isLoggedIn()) {
                    log('Not logged in, calling login...');
                    trackEvent('liff_login_redirect');
                    liff.login({ 
                        redirectUri: window.location.href,
                        botPrompt: 'normal'
                    });
                    return;
                }
                
                log('Init success. Logged In.');
                trackEvent('liff_init_success', { isInClient: liff.isInClient() });
                await runRender();
            } catch (err) { 
                log('LIFF init failed: ' + err);
                trackEvent('liff_init_error', { error: err.message || String(err) });
                // Fallback render
                await runRender();
            }
        }

        // --- æ­·å²è¨‚å–®é‚è¼¯ ---
        async function loadOrderHistory(userId) {
            const listContainer = document.getElementById('orderList');
            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${userId}`);
                const data = await response.json();

                // è™•ç†å¾…ä»˜æ¬¾ç¸½é¡ (å–çµ•å°å€¼ä¸¦åŠ ä¸Šåƒåˆ†ä½)
                const total = Math.abs(data.unpaid_total || 0);
                document.getElementById('unpaidTotal').innerText = `$${total.toLocaleString()}`;

                if (!data.orders || data.orders.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400 py-10">å°šç„¡ç´€éŒ„</p>';
                    return;
                }

                listContainer.innerHTML = data.orders.map(order => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-400 font-mono">${order.order_no}</span>
                            <span class="px-2 py-0.5 rounded text-[10px] ${order.status === 'unpaid' ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-500'}">
                                ${order.status === 'unpaid' ? 'å¾…ä»˜æ¬¾' : 'å·²çµæ¸…'}
                            </span>
                        </div>
                        <div class="space-y-1 mb-2">
                            ${order.items.map(item => `
                                <div class="flex justify-between items-center text-sm italic py-1">
                                    <div class="flex items-center gap-2">
                                        ${item.image ? `<img src="${item.image}" class="w-10 h-10 object-cover rounded border border-gray-100" loading="lazy">` : ''}
                                        <div class="flex flex-col">
                                            <span class="text-gray-600">${item.name}</span>
                                            <span class="text-xs text-gray-400">x${item.qty}</span>
                                        </div>
                                    </div>
                                    <span class="text-gray-900">$${item.price}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-50 text-[10px]">
                            <span class="text-gray-400">${order.date}</span>
                            <span class="text-gray-900 font-bold text-sm">$${Math.abs(order.total).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                listContainer.innerHTML = '<p class="text-center text-red-400">é€£ç·š API å¤±æ•—</p>';
            }
        }

        // --- åŸæœ‰çš„å–Šå–®æ¸²æŸ“é‚è¼¯ ---
        function renderQuickOrder() {
            state.uid = getParam('uid') || 'Unknown';
            state.name = getParam('name') || 'å•†å“';
            state.price = getParam('price') || '0';
            
            document.getElementById('prodName').innerText = state.name;
            document.getElementById('prodPrice').innerText = `$${state.price}`;
            renderButtons('colorContainer', getParam('colors'), 'color');
            renderButtons('sizeContainer', getParam('sizes'), 'size');
        }

        function renderButtons(containerId, dataStr, type) {
            const container = document.getElementById(containerId);
            if (!dataStr || dataStr.toLowerCase() === 'none') {
                container.innerHTML = `<span class="text-gray-400 text-sm">ç„¡</span>`;
                state[type] = 'None';
                return;
            }
            const items = dataStr.split(',');
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.innerText = item;
                btn.className = "px-4 py-2 border-2 border-gray-100 rounded-lg text-sm transition-all";
                btn.onclick = () => {
                    state[type] = item;
                    Array.from(container.children).forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                };
                container.appendChild(btn);
            });
            if (items.length === 1) container.firstChild.click();
        }

        function updateQty(n) {
            state.qty = Math.max(1, state.qty + n);
            document.getElementById('qtyText').innerText = state.qty;
        }

        async function addToCart() {
            // Validate selections
            if (!state.color || !state.size) {
                alert('è«‹å®Œæ•´é¸æ“‡é¡è‰²èˆ‡å°ºå¯¸');
                return;
            }

            // Get userId from LIFF
            let userId = null;
            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    userId = liff.getContext()?.userId;
                }
            } catch(e) {
                console.error('Cannot get userId', e);
            }
            
            if (!userId) {
                alert('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Šï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿ');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#addToCartBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">åŠ å…¥ä¸­...</span>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        productId: state.uid,
                        productName: state.name,
                        productPrice: parseFloat(state.price) || 0,
                        productImage: getParam('image') || '',
                        color: state.color,
                        size: state.size,
                        quantity: state.qty
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    trackEvent('add_to_cart_success', { uid: state.uid, name: state.name });
                    showAddedToCartModal(data.cartCount);
                } else {
                    trackEvent('add_to_cart_error', { message: data.message });
                    alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (err) {
                trackEvent('add_to_cart_network_error', { error: String(err) });
                console.error('Add to cart error:', err);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function showAddedToCartModal(cartCount) {
            document.getElementById('modalCartCount').textContent = cartCount;
            document.getElementById('addedModal').classList.remove('hidden');
        }

        function goToCart() {
            // Reload page with page=cart param
            const url = new URL(window.location.href);
            url.searchParams.set('page', 'cart');
            window.location.href = url.toString();
        }

        function continueShopping() {
             liff.closeWindow();
        }

        // Store current cart items for checkout
        let currentCartItems = [];

        // Load cart from API
        async function loadCart(userId) {
            const loading = document.getElementById('cartLoading');
            const itemsContainer = document.getElementById('cartItems');
            const emptyState = document.getElementById('emptyCart');
            const footer = document.getElementById('cartFooter');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/${userId}`);
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (!data.success || !data.items || data.items.length === 0) {
                    emptyState.classList.remove('hidden');
                    footer.classList.add('hidden');
                    currentCartItems = [];
                    return;
                }
                
                // Store cart items for checkout
                currentCartItems = data.items;
                
                renderCartItems(data.items);
                updateCartSummary(data.totalItems, data.totalAmount);
                
                itemsContainer.classList.remove('hidden');
                footer.classList.remove('hidden');
                
            } catch (err) {
                console.error('Load cart error:', err);
                loading.innerHTML = '<p class="text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</p>';
            }
        }

        // Render cart items
        function renderCartItems(items) {
            const container = document.getElementById('cartItems');
            
            container.innerHTML = items.map(item => `
                <div class="p-4 flex gap-4" data-item-id="${item.id}">
                    <!-- Product Image -->
                    <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                        ${item.productImage 
                            ? `<img src="${item.productImage}" class="w-full h-full object-cover" alt="${item.productName}">`
                            : `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                 <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                 </svg>
                               </div>`
                        }
                    </div>
                    
                    <!-- Product Info -->
                    <div class="flex-1 min-w-0">
                        <h3 class="font-medium text-gray-900 truncate">${item.productName}</h3>
                        <p class="text-sm text-gray-500">${item.color} / ${item.size}</p>
                        <p class="text-red-500 font-bold mt-1">$${item.productPrice.toLocaleString()}</p>
                    </div>
                    
                    <!-- Quantity & Delete -->
                    <div class="flex flex-col items-end justify-between">
                        <button onclick="removeCartItem(${item.id})" class="text-gray-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                        <div class="flex items-center border rounded-lg">
                            <button onclick="updateCartQty(${item.id}, ${item.quantity - 1})" class="px-2 py-1 text-gray-500 hover:bg-gray-100 ${item.quantity <= 1 ? 'opacity-50' : ''}">âˆ’</button>
                            <span class="px-3 py-1 text-sm font-medium">${item.quantity}</span>
                            <button onclick="updateCartQty(${item.id}, ${item.quantity + 1})" class="px-2 py-1 text-gray-500 hover:bg-gray-100">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update cart summary
        function updateCartSummary(totalItems, totalAmount) {
            document.getElementById('cartItemCount').textContent = totalItems;
            document.getElementById('cartTotal').textContent = `$${totalAmount.toLocaleString()}`;
        }

        // Update item quantity
        async function updateCartQty(itemId, newQty) {
            if (newQty < 1) {
                if (confirm('ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ')) {
                    removeCartItem(itemId);
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, quantity: newQty })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload cart to reflect changes
                    const userId = liff.getContext()?.userId;
                    if (userId) loadCart(userId);
                } else {
                    alert('æ›´æ–°å¤±æ•—ï¼š' + data.message);
                }
            } catch (err) {
                console.error('Update cart error:', err);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // Remove item from cart
        async function removeCartItem(itemId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cart/item/${itemId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload cart
                    const userId = liff.getContext()?.userId;
                    if (userId) loadCart(userId);
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
                }
            } catch (err) {
                console.error('Remove item error:', err);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // Checkout - Use LINE Pay
        async function checkout() {
            trackEvent('checkout_click', { itemCount: currentCartItems.length });
            
            if (!currentCartItems || currentCartItems.length === 0) {
                alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
                return;
            }
            
            // Get userId
            let userId = null;
            try {
                if (liff.isLoggedIn()) {
                    userId = liff.getContext()?.userId;
                }
            } catch (e) {
                console.error('Cannot get userId', e);
            }
            
            if (!userId) {
                alert('ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Šï¼Œè«‹åœ¨ LINE ä¸­é–‹å•Ÿ');
                return;
            }
            
            // Calculate total
            const totalAmount = currentCartItems.reduce((sum, item) => 
                sum + (item.productPrice * item.quantity), 0
            );
            
            log(`æº–å‚™ LINE Pay çµå¸³: ${currentCartItems.length} ä»¶å•†å“, ç¸½è¨ˆ $${totalAmount}`);
            trackEvent('linepay_checkout_start', { items: currentCartItems.length, totalAmount });
            
            // Show loading modal
            document.getElementById('linePayLoadingModal').classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/linepay/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        items: currentCartItems,
                        totalAmount: Math.round(totalAmount)  // LINE Pay requires integer
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.paymentUrl) {
                    trackEvent('linepay_redirect', { orderId: data.orderId, transactionId: data.transactionId });
                    log('LINE Pay URL: ' + data.paymentUrl);
                    
                    // Redirect to LINE Pay
                    window.location.href = data.paymentUrl;
                } else {
                    document.getElementById('linePayLoadingModal').classList.add('hidden');
                    trackEvent('linepay_request_error', { message: data.message });
                    alert('ç„¡æ³•å»ºç«‹ä»˜æ¬¾è«‹æ±‚ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (err) {
                document.getElementById('linePayLoadingModal').classList.add('hidden');
                trackEvent('linepay_network_error', { error: String(err) });
                console.error('LINE Pay request error:', err);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // Handle payment result from LINE Pay callback
        function handlePaymentResult(result, orderId, errorMsg) {
            const modal = document.getElementById('paymentResultModal');
            const successIcon = document.getElementById('paymentSuccessIcon');
            const errorIcon = document.getElementById('paymentErrorIcon');
            const cancelledIcon = document.getElementById('paymentCancelledIcon');
            const title = document.getElementById('paymentResultTitle');
            const message = document.getElementById('paymentResultMessage');
            
            // Hide all icons first
            successIcon.classList.add('hidden');
            errorIcon.classList.add('hidden');
            cancelledIcon.classList.add('hidden');
            
            if (result === 'success') {
                successIcon.classList.remove('hidden');
                title.textContent = 'ä»˜æ¬¾æˆåŠŸï¼';
                message.textContent = `è¨‚å–®ç·¨è™Ÿï¼š${orderId || '---'}\næ„Ÿè¬æ‚¨çš„è³¼è²·ï¼`;
                trackEvent('payment_success', { orderId });
            } else if (result === 'cancelled') {
                cancelledIcon.classList.remove('hidden');
                title.textContent = 'ä»˜æ¬¾å·²å–æ¶ˆ';
                message.textContent = 'æ‚¨å·²å–æ¶ˆæ­¤æ¬¡ä»˜æ¬¾ã€‚è³¼ç‰©è»Šå•†å“ä»ä¿ç•™ï¼Œå¯éš¨æ™‚çµå¸³ã€‚';
                trackEvent('payment_cancelled', { orderId });
            } else {
                errorIcon.classList.remove('hidden');
                title.textContent = 'ä»˜æ¬¾å¤±æ•—';
                message.textContent = errorMsg ? `éŒ¯èª¤ï¼š${errorMsg}` : 'ä»˜æ¬¾è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                trackEvent('payment_error', { orderId, errorMsg });
            }
            
            modal.classList.remove('hidden');
            
            // Clean URL params
            const cleanUrl = new URL(window.location.href);
            cleanUrl.searchParams.delete('payment');
            cleanUrl.searchParams.delete('orderId');
            cleanUrl.searchParams.delete('msg');
            window.history.replaceState({}, '', cleanUrl.toString());
        }
        
        function closePaymentResult() {
            document.getElementById('paymentResultModal').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>